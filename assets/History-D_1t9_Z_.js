import{b as k,a as A,e as N,u as e,f as P}from"./index-DJKKYvGv.js";import{d as s,A as E,y as f,q as y,k as q}from"./react-vendor-BYlzYzcd.js";import{H as S}from"./Helmet-Hq4EtTxH.js";import{M as D}from"./MovieCard-BNWtjiUN.js";/* empty css                  */const K=()=>{const{user:o}=k(),[i,n]=s([]),[F,m]=s(!0),[L,g]=s(null),[a,w]=s(!1),[l,p]=s(!0),{removeContinueWatchingItem:B,fetchContinueWatching:x}=A(),c=E(null),H=E(!1),d=E(!0);f(()=>{H.current=a},[a]),f(()=>{d.current=l},[l]);const v=y(async()=>{if(!o){m(!1);return}m(!0),g(null),n([]),p(!0);try{await M(0,!0)}catch(t){console.error("Error fetching watch history:",t),g("Failed to load watch history. Please try again."),n([])}finally{m(!1)}},[o]),M=y(async(t=0,r=!1)=>{if(o&&!(!r&&!d.current)){r||w(!0);try{const u=await N(o.id,t,20);if(u.length===0){p(!1),r||w(!1);return}n(W=>{const z=new Set(W.map(_=>_.watch_id)),Y=u.filter(_=>!z.has(_.watch_id));return[...W,...Y]}),u.length<20&&p(!1)}catch(h){console.error("Error loading history batch:",h),r&&g("Failed to load watch history. Please try again.")}finally{r||w(!1)}}},[o]),R=y(()=>{!H.current&&d.current&&n(t=>(M(t.length,!1),t))},[M]),b=y(()=>{c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{const t=window.pageYOffset||document.documentElement.scrollTop,r=window.innerHeight,h=document.documentElement.scrollHeight;t+r>=h-200&&!H.current&&d.current&&R()},100)},[R,a,l]);f(()=>{v()},[v,o]),f(()=>(window.addEventListener("scroll",b,{passive:!0}),()=>{window.removeEventListener("scroll",b),c.current&&clearTimeout(c.current)}),[b]);const C=async t=>{n(i.filter(r=>r.watch_id!==t.watch_id)),B(t.media_id);try{await P(o.id,t),await x(o.id)}catch(r){console.error("Failed to delete item or refetch continue watching:",r)}},T=()=>{v()};return F?e("div",{class:"container",children:e("p",{children:"Loading watch history..."})}):L?e("div",{class:"container",children:[e(S,{children:e("title",{children:"Watch History - Fylm"})}),e("h1",{children:"Watch History"}),e("div",{class:"error-message",children:[e("p",{children:L}),e("button",{onClick:T,class:"retry-button",children:"Retry"})]})]}):e("div",{class:"container",children:[e(S,{children:e("title",{children:"Watch History - Fylm"})}),e("h1",{children:"Watch History"}),i.length>0?e(q,{children:[e("div",{class:"movie-grid",children:i.map(t=>e(D,{item:t,type:t.type,progress:t.progress_seconds,duration:t.duration_seconds,showDeleteButton:!0,onDelete:C,useFullResolution:!0},t.watch_id))}),a&&e("div",{class:"loading-more-container",children:e("p",{class:"loading-more-text",children:"Loading more items..."})}),!l&&i.length>0&&e("div",{class:"end-of-list-container",children:e("p",{class:"end-of-list-text",children:"You've reached the end of your watch history"})})]}):!F&&e("p",{children:"Your watch history is empty."})]})};export{K as default};
//# sourceMappingURL=History-D_1t9_Z_.js.map
